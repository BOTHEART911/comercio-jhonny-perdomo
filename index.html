<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>PORTAL COMERCIAL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="https://res.cloudinary.com/dqqeavica/image/upload/v1759697569/Jhonny_tvexdy.png">
  <link rel="manifest" href="manifest.webmanifest">

  <!-- Choices (select mejorado) -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

 <style>
    :root{
      --primary:#007BFF;
      --primary-2:#0056b3;
      --ok:#16a34a;
      --error:#dc2626;
      --scrim:rgba(0,0,0,.35);
      --panel:#2f6bdb;
      --aqua:#7de3ef;
    }
    html,body{
      margin:0; padding:0; height:100%; width:100%;
      overflow-x:hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#111;
      background: url('https://res.cloudinary.com/dqqeavica/image/upload/v1753538930/FONDO_JHONNY_sugwsj.png') center/cover fixed no-repeat;
    }
    .container{ max-width: 1000px; margin: 0 auto; padding: 16px; }

    /* Vistas */
    .view{ display:none; opacity:0; transform: translateY(8px);
      transition: opacity .25s ease, transform .25s ease;
      min-height: 0;
      box-sizing:border-box; padding:0 16px;
    }
    .view.active{ display:block; opacity:1; transform: translateY(0); }
    .view > *:first-child{ margin-top: 0 !important; }
    .view > *:last-child{ margin-bottom: 0 !important; }

    /* Tarjetas */
    .card{
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(3px);
      border: 2px solid #ddd; border-radius: 10px;
      box-shadow: 0 8px 18px rgba(0,0,0,.15);
      max-width: 760px; margin: 16px auto; padding: 16px 16px 12px 16px;
    }
    .narrow{ max-width: 640px; margin: 0 auto; }
    h1,h2{ margin: 8px 0 12px; text-align:center; }
    p.helper{ color:#333; font-size:.95rem; text-align:center; margin:8px 0 16px; }
    label{ display:block; font-weight:800; margin: 12px 0 6px; color:var(--primary); }
    .desc{ margin:-4px 0 8px; color:#222; font-size:.9rem; }
    input, select, textarea, button{
      width:100%; padding:12px; box-sizing:border-box;
      border:1.5px solid #ccc; border-radius:8px; background:#fff;
      outline:none; transition: border-color .2s ease, transform .08s ease;
      font-size:16px;
    }
    textarea{ resize:vertical; }
    input:focus, select:focus, textarea:focus{ border-color:var(--primary); }
    button{
      cursor:pointer; border:2px solid var(--primary);
      background:#fff; color:#000; font-weight:800; border-radius:999px;
    }
    button:hover{ background:var(--primary-2); color:#fff; border-color:var(--primary-2); }
    .btn-primary{ background:var(--primary); color:#fff; }
    .btn-row{ display:flex; gap:12px; }
    .btn-row > *{ flex:1; }
    @media (max-width: 700px){ .btn-row{ flex-direction:column; } }
    .muted{ color:#666; font-size:.9rem; }
    .center{ text-align:center; }
    .brand{ width:210px; border-radius:8px; display:block; margin:12px auto 4px; }

    /* Loader centrado */
    .loader{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.35);
      z-index:9999; backdrop-filter: blur(2px);
      opacity:1; transition: opacity .12s ease;
    }
    .loader.hidden{ display:flex !important; opacity:0; pointer-events:none; }
    .spinner-ios{ position:relative; width:64px; height:64px; }
    .spinner-ios i{
      position:absolute; left:50%; top:50%;
      width:6px; height:18px; margin:-9px 0 0 -3px;
      background:#fff; border-radius:3px; opacity:.2;
      animation:iosFade 1.2s linear infinite;
      transform-origin: center center;
    }
    @keyframes iosFade{ 0%,39%,100%{opacity:.2;} 40%{opacity:1;} }
    .spinner-ios i:nth-child(1)  { transform: rotate(  0deg) translateY(-24px); animation-delay:-1.1s; }
    .spinner-ios i:nth-child(2)  { transform: rotate( 30deg) translateY(-24px); animation-delay:-1.0s; }
    .spinner-ios i:nth-child(3)  { transform: rotate( 60deg) translateY(-24px); animation-delay:-0.9s; }
    .spinner-ios i:nth-child(4)  { transform: rotate( 90deg) translateY(-24px); animation-delay:-0.8s; }
    .spinner-ios i:nth-child(5)  { transform: rotate(120deg) translateY(-24px); animation-delay:-0.7s; }
    .spinner-ios i:nth-child(6)  { transform: rotate(150deg) translateY(-24px); animation-delay:-0.6s; }
    .spinner-ios i:nth-child(7)  { transform: rotate(180deg) translateY(-24px); animation-delay:-0.5s; }
    .spinner-ios i:nth-child(8)  { transform: rotate(210deg) translateY(-24px); animation-delay:-0.4s; }
    .spinner-ios i:nth-child(9)  { transform: rotate(240deg) translateY(-24px); animation-delay:-0.3s; }
    .spinner-ios i:nth-child(10) { transform: rotate(270deg) translateY(-24px); animation-delay:-0.2s; }
    .spinner-ios i:nth-child(11) { transform: rotate(300deg) translateY(-24px); animation-delay:-0.1s; }
    .spinner-ios i:nth-child(12) { transform: rotate(330deg) translateY(-24px); animation-delay: 0s; }

    /* Overlay lateral (men√∫): estilo referencia, con aire y copy */
    .overlay{ position: fixed; inset: 0; pointer-events:none; }
    .overlay .scrim{ position:absolute; inset:0; background:var(--scrim); opacity:0; transition:opacity .25s ease; }
    .overlay .panel{
      position:absolute; top:0; left:0; width:min(360px, 90vw); height:100%;
      background:var(--panel); color:#fff; padding:16px; box-sizing:border-box;
      transform: translateX(-100%); transition: transform .25s ease;
      display:flex; flex-direction:column; gap:14px; overflow-y:auto; min-height:0;
    }
    .overlay.open{ pointer-events:auto; }
    .overlay.open .scrim{ opacity:1; }
    .overlay.open .panel{ transform: translateX(0); }
    .panel h3{ margin: 0 0 6px; text-align:center; font-weight:900; }
    .menu-btn{
      background:var(--aqua); color:#000; border:0; font-weight:800;
      border-radius:999px; padding:12px; box-shadow: 0 6px 12px rgba(0,0,0,.18);
      margin: 4px 0; /* aire vertical entre botones */
    }
    .ovl-header{ display:flex; align-items:center; justify-content:center; }
    .ovl-brand{ max-width:180px; border-radius:10px; display:block; margin: 2px auto 0; }
    .ovl-copy{ text-align:center; font-size:.9rem; margin-top:4px; }

    /* Avatar Comercio + t√≠tulo en men√∫ (como ‚ÄúComerciantes‚Äù) */
    .avatar-wrap{ display:flex; flex-direction:column; align-items:center; gap:8px; margin:8px 0; }
    .avatar{
      width:150px; height:150px; border-radius:14px; object-fit:cover;
      border:2px solid #ddd; background:#eee; box-shadow: 0 8px 18px rgba(0,0,0,.2);
    }
    .c-nombre{
      font-weight:900; text-align:center; color:#111;
      font-size:1.35rem; line-height:1.2; text-transform:uppercase;
      letter-spacing:.3px; margin-top:2px;
    }

    /* Campos con icono al lado (apps) */
    .input-with-icon{ display:flex; gap:10px; align-items:center; }
    .input-with-icon a.icon-btn{
      flex:0 0 auto; display:inline-flex; align-items:center; justify-content:center;
      width:44px; height:44px; border-radius:10px; border:2px solid var(--primary);
      background:#fff; box-shadow: 0 6px 12px rgba(0,0,0,.18);
    }
    .input-with-icon a.icon-btn img{ width:24px; height:24px; object-fit:contain; border-radius:6px; background:#fff; }

    /* Video Card */
    .video-card{
      position:relative; width: min(560px, 90vw); aspect-ratio: 16 / 9;
      margin: 12px auto; background:#000; border-radius: 14px; overflow:hidden;
      border:2px solid #ddd; box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    .video-card .video-thumb{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; display:block; }
    .video-card .play-layer{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background: radial-gradient(circle at center, rgba(255,255,255,.18), rgba(0,0,0,.55));
      color:#fff; font-size: 64px; cursor:pointer; transition: opacity .2s ease;
    }
    .video-card.playing .play-layer{ opacity:0; pointer-events:none; }
    .video-card.playing .video-thumb{ display:none; }
    .video-card video, .video-card iframe{ width:100%; height:100%; display:block; }

    .hidden{ display:none !important; }

    /* Vista Instalar */
    #view-instalar{
      display:flex;
      align-items:center;
      justify-content:center;
      min-height: calc(100dvh - 32px);
      text-align:center;
    }
    #view-instalar .install-wrap{
      display:flex; flex-direction:column; align-items:center; gap:12px; padding:8px;
    }
    #view-instalar .brand{ width:220px; border-radius:8px; }
    #view-instalar .tagline{ font-weight:800; color:#111; margin:0; }
    .btn-with-icon{ display:flex; align-items:center; justify-content:center; gap:10px; }

/* Quitar todo espacio vertical entre vistas y tarjetas */
.container{
  padding-block: 0 !important;       /* sin aire arriba/abajo en el contenedor */
}
.view{
  padding: 0 !important;
  margin: 0 !important;
  min-height: auto !important;        /* altura exacta al contenido */
}
.view > *{
  margin-block: 0 !important;         /* sin m√°rgenes superiores/inferiores entre hijos directos */
}
.view > .card{
  margin: 0 auto !important;          /* tarjeta pegada, centrada, sin margen vertical */
}

/* Elimina m√°rgenes inline en filas de botones (incluye el margin-bottom:12px inline) */
.view .btn-row{
  margin: 0 !important;
}
#view-menu .btn-row{
  margin: 0 !important;
}

/* La tarjeta conserva un poco de respiraci√≥n interna */
.card{
  padding-block: 12px !important;
}

/* Evitar que contenedores internos introduzcan altura extra */
.narrow{
  margin: 0 auto !important;
}

/* Vista Instalar sin altura forzada */
#view-instalar{
  min-height: auto !important;
}

/* Botones superiores como la referencia: 
   - MEN√ö: blanco, borde azul
   - Cerrar Sesi√≥n: rojo */
#view-menu #btn-open-menu{
  background: #fff !important;
  color: #0b3ea7 !important;
  border: 2px solid var(--primary) !important;
  box-shadow: 0 6px 12px rgba(0,0,0,.18);
}
#view-menu #btn-open-menu:hover{
  background: var(--primary-2) !important;
  color: #fff !important;
  border-color: var(--primary-2) !important;
}

#view-menu #btn-logout{
  background: #dc2626 !important;     /* rojo */
  color: #fff !important;
  border: 2px solid #dc2626 !important;
  box-shadow: 0 6px 12px rgba(0,0,0,.18);
}
#view-menu #btn-logout:hover{
  background: #b91c1c !important;     /* rojo m√°s oscuro */
  border-color: #b91c1c !important;
}

   /* Recorte global: sin espacio vertical extra en vistas */
.container{ padding-bottom: 0 !important; }
.view{
  padding-top: 0 !important;
  padding-bottom: 0 !important;
}
/* Evitar m√°rgenes colapsados del primer y √∫ltimo elemento en cada vista,
   manteniendo el espaciado interno normal entre elementos */
.view > *:first-child{ margin-top: 0 !important; }
.view > *:last-child{ margin-bottom: 0 !important; }

/* Panel lateral (men√∫): quita aire arriba/abajo y evita ‚Äúfantasmas‚Äù */
.overlay .panel{
  padding-top: 16px !important;
  padding-bottom: 0 !important;
}
.overlay .panel > *:first-child{ margin-top: 0 !important; }
.overlay .panel > *:last-child{ margin-bottom: 0 !important; }

/* La vista ‚ÄúInstalar‚Äù no ocupa espacio si no est√° activa */
#view-instalar.view{ display: none !important; }
#view-instalar.view.active{ display: flex !important; }

  /* Tama√±o configurable solo para la vista MEN√ö */
:root{
  --menu-avatar-size: 180px;  /* cambia aqu√≠ el tama√±o de la imagen (antes ~150px) */
  --menu-name-size: 1.7rem;   /* cambia aqu√≠ el tama√±o del nombre (antes ~1.35rem) */
}

#view-menu .avatar{
  width: var(--menu-avatar-size);
  height: var(--menu-avatar-size);
}

#view-menu .c-nombre{
  font-size: var(--menu-name-size);
}
   
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="loader" class="loader hidden" aria-live="polite" aria-busy="true">
    <div class="spinner-ios" role="status" aria-label="Cargando">
      <i></i><i></i><i></i><i></i><i></i><i></i>
      <i></i><i></i><i></i><i></i><i></i><i></i>
    </div>
  </div>

  <div class="container">

    <!-- VISTA: LOGIN -->
    <section id="view-login" class="view active">
      <div class="card">
        <h1 style="color:var(--primary); text-shadow: 0 2px 2px #031732;">PORTAL COMERCIAL</h1>
        <p class="helper"><b>Al usar esta aplicaci√≥n, aceptas voluntariamente suministrar los datos de tu Comercio.</b><br><i>Art. 5 Ley 1581 de 2012 y Decreto 1074 de 2015</i></p>

        <label>NIT / Documento del Comercio</label>
        <p class="desc">Ingresa tu NIT o n√∫mero de documento sin puntos ni espacios.</p>
        <input id="doc-login" type="tel" inputmode="numeric" placeholder="Sin puntos ni espacios" />

        <div class="btn-row" style="margin-top:12px;">
          <button class="btn-primary" id="btn-login">Iniciar Sesi√≥n</button>
          <button id="btn-compartir" class="btn-with-icon">
            <span>Compartir App</span>
          </button>
        </div>

        <img class="brand" alt="Brand" src="https://res.cloudinary.com/dqqeavica/image/upload/v1753538919/BANNER_JHONNY_e0yw7m.png" />
        <p class="center muted">Copyright ¬© <a href="https://wa.me/573103230712" target="_blank"><b>Oscar Polan√≠a</b></a></p>
      </div>

      <!-- REGISTRO COMERCIO (solo si no existe) -->
      <div id="registro-card" class="card" style="display:none;">
        <h2 style="color:var(--primary)">DATOS DE TU COMERCIO</h2>

        <div class="narrow">
          <!-- 1. Categor√≠a -->
          <label>Categor√≠a de tu Comercio</label>
          <p class="desc">Selecciona tu Categor√≠a (requerido).</p>
          <select id="reg-categoria">
            <option value="" disabled selected>Selecciona tu Categor√≠a</option>
          </select>

          <!-- 2. Especificaciones (readonly) -->
          <label>Especificaciones</label>
          <p class="desc">Ubica tu Comercio dentro de estas especificaciones. Se actualiza al elegir categor√≠a.</p>
          <textarea id="reg-especificaciones" rows="5" readonly placeholder="Selecciona una categor√≠a para ver las especificaciones"></textarea>

          <!-- 3. Nombre del Comercio -->
          <label>Nombre del Comercio</label>
          <p class="desc">No uses un nombre extenso (requerido).</p>
          <input id="reg-nombre" type="text" placeholder="Nombre de tu Comercio" />

          <!-- 4. Descripci√≥n -->
          <label>Descripci√≥n del Comercio</label>
          <p class="desc">Describe brevemente tu Comercio (requerido).</p>
          <textarea id="reg-descripcion" rows="4" placeholder="Descripci√≥n breve"></textarea>

          <!-- 5. Imagen -->
          <label>Imagen del Comercio</label>
          <p class="desc">Carga una imagen publicitaria de tu Comercio (requerido).</p>
          <div>
            <input type="file" id="reg-foto" accept="image/*">
            <img id="reg-preview" src="" alt="Vista previa" style="display:none; max-width:100%; border-radius:10px; border:1px solid #ddd; margin-top:8px;" />
          </div>

          <!-- 6. Direcci√≥n -->
          <label>Direcci√≥n del Comercio</label>
          <p class="desc">Escribe correctamente la Direcci√≥n de tu Comercio (requerido).</p>
          <input id="reg-direccion" type="text" placeholder="Direcci√≥n del Comercio" />

          <!-- 7. Ubicaci√≥n (Maps) -->
          <label>Ubicaci√≥n del Comercio</label>
          <p class="desc">Abre Google Maps, comparte el enlace del lugar y p√©galo aqu√≠ (opcional).</p>
          <div class="input-with-icon">
            <input id="reg-ubicacion" type="url" placeholder="https://maps.app.goo.gl/..." />
            <a id="mapsLink" class="icon-btn" href="#" target="_blank" rel="noopener" title="Instalar/Abrir Google Maps">
              <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1760108968/ubicacion_zicnod.png" alt="Maps">
            </a>
          </div>

          <!-- 8. Oferta -->
          <label>Oferta del Comercio</label>
          <p class="desc">Describe puntualmente la oferta para usuarios activos de la App (requerido).</p>
          <textarea id="reg-oferta" rows="3" placeholder="Describe la oferta aqu√≠"></textarea>

          <!-- 9. Facebook -->
          <label>Facebook</label>
          <p class="desc">Comparte el perfil/p√°gina de tu Comercio y pega el enlace aqu√≠ (opcional).</p>
          <div class="input-with-icon">
            <input id="reg-facebook" type="url" placeholder="https://www.facebook.com/share/..." />
            <a id="facebookLink" class="icon-btn" href="#" target="_blank" rel="noopener" title="Instalar/Abrir Facebook">
              <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1759166342/facebook_nezbkz.webp" alt="Facebook">
            </a>
          </div>

          <!-- 10. Instagram -->
          <label>Instagram</label>
          <p class="desc">Comparte el perfil de tu Comercio y pega el enlace aqu√≠ (opcional).</p>
          <div class="input-with-icon">
            <input id="reg-instagram" type="url" placeholder="https://www.instagram.com/tuusuario" />
            <a id="instagramLink" class="icon-btn" href="#" target="_blank" rel="noopener" title="Instalar/Abrir Instagram">
              <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1759166342/instragram_uft2wl.webp" alt="Instagram">
            </a>
          </div>

          <!-- 11. TikTok -->
          <label>TikTok</label>
          <p class="desc">Comparte el perfil de tu Comercio y pega el enlace aqu√≠ (opcional).</p>
          <div class="input-with-icon">
            <input id="reg-tiktok" type="url" placeholder="https://www.tiktok.com/@usuario..." />
            <a id="tiktokLink" class="icon-btn" href="#" target="_blank" rel="noopener" title="Instalar/Abrir TikTok">
              <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1759166342/tiktok_tdvc2x.webp" alt="TikTok">
            </a>
          </div>

          <!-- 12. WhatsApp -->
          <label>WhatsApp</label>
          <p class="desc">Escribe el n√∫mero WhatsApp de tu Comercio (requerido, solo d√≠gitos).</p>
          <input id="reg-whatsapp" type="tel" inputmode="numeric" placeholder="10 d√≠gitos (ej. 310...)" />

          <!-- 13. Tel√©fono -->
          <label>Tel√©fono</label>
          <p class="desc">Escribe el n√∫mero telef√≥nico de tu Comercio (opcional).</p>
          <input id="reg-telefono" type="tel" inputmode="numeric" placeholder="Fijo o m√≥vil" />

          <div class="btn-row" style="margin-top:14px;">
            <button class="btn-primary" id="btn-guardar-registro">Guardar</button>
            <button id="btn-reg-atras">Atr√°s</button>
          </div>
          <p class="center muted" style="margin-top:10px;"><b>Revisa la informaci√≥n antes de guardar.</b></p>
        </div>
      </div>
    </section>

    <!-- VISTA: MEN√ö -->
    <section id="view-menu" class="view">
      <div class="btn-row" style="margin-bottom:12px;">
        <button class="menu-btn" id="btn-open-menu">MEN√ö</button>
        <button class="menu-btn" id="btn-logout">Cerrar Sesi√≥n</button>
      </div>

      <div class="card narrow">
        <div class="avatar-wrap">
          <img id="c-thumb" class="avatar" alt="Comercio" src="https://res.cloudinary.com/dqqeavica/image/upload/v1759798601/noticias_dax8sd.jpg" />
          <div id="c-nombre" class="c-nombre">NOMBRE DEL COMERCIO</div>
        </div>

        <div class="narrow">
          <p><b>Estado:</b> <span id="c-estado">-</span></p>
          <p><b>Direcci√≥n:</b> <span id="c-direccion">-</span></p>
          <p><b>NIT:</b> <span id="c-nit">-</span></p>
          <p><b>Categor√≠a:</b> <span id="c-categoria">-</span></p>
          <p><b>Descripci√≥n:</b> <span id="c-descripcion">-</span></p>
          <p><b>Oferta:</b> <span id="c-oferta">-</span></p>
          <p><b>WhatsApp:</b> <span id="c-whatsapp">-</span></p>
        </div>
      </div>

      <!-- Video de bienvenida -->
      <div class="video-card" id="videoCard">
        <img id="videoThumb" class="video-thumb" src="https://res.cloudinary.com/dqqeavica/image/upload/v1759802023/Miniatura_ilkloy.png" alt="Video miniatura">
        <div class="play-layer" id="playLayer">‚ñ∂</div>
      </div>

      <div class="narrow">
        <img class="brand" alt="Brand" src="https://res.cloudinary.com/dqqeavica/image/upload/v1753538919/BANNER_JHONNY_e0yw7m.png" />
        <p class="center muted">Copyright ¬© <a href="https://wa.me/573103230712" target="_blank"><b>Oscar Polan√≠a</b></a></p>
      </div>
    </section>

    <!-- OVERLAY (men√∫ lateral, estilo referencia) -->
    <div class="overlay" id="overlay">
      <div class="scrim" id="ovlClose"></div>
      <aside class="panel">
        <div class="btn-row">
          <button id="btn-ovl-back" style="background:#fff; color:#000;">ATR√ÅS</button>
        </div>

        <div class="ovl-header">
          <img class="ovl-brand" alt="banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1759696513/Jhonny_y1tslf.gif" />
        </div>

        <h3>Selecciona una opci√≥n</h3>
        <button class="menu-btn" id="go-politicas">Pol√≠ticas de Uso</button>
        <button class="menu-btn" id="go-actualiza">Actualiza tus Datos</button>
        <button class="menu-btn" id="go-validar">Validar Usuario</button>
        <button class="menu-btn" id="go-descargar">Descarga la App Jhonny Perdomo</button>
        <button class="menu-btn" id="btn-instalar" style="display:none;">Instalar la App üì≤</button>

        <img class="brand" alt="Brand" src="https://res.cloudinary.com/dqqeavica/image/upload/v1753538919/BANNER_JHONNY_e0yw7m.png" />
        <p class="ovl-copy">Copyright ¬© <a href="https://wa.me/573103230712" target="_blank" style="color:#fff;"><b>Oscar Polan√≠a</b></a></p>
      </aside>
    </div>

    <!-- VISTA: POL√çTICAS -->
    <section id="view-politicas" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">Pol√≠ticas de Uso</h2>
        <div style="background:rgba(255,255,255,.9); border:2px solid #ddd; border-radius:12px; padding:12px;">
          <ul style="line-height:1.6; margin:0 0 8px 0;">
            <li>El registro autoriza el uso de datos del Comercio conforme a la Ley 1581 de 2012.</li>
            <li>Las im√°genes y textos enviados deben ser veraces y de tu propiedad.</li>
            <li>Los enlaces a redes sociales o ubicaci√≥n deben corresponder a tu Comercio.</li>
            <li>La App puede moderar o despublicar informaci√≥n que infrinja normas.</li>
            <li>El estado del Comercio (ACTIVO/INACTIVO) puede cambiar por verificaci√≥n.</li>
          </ul>
        </div>
        <div class="btn-row" style="margin-top:12px;">
          <button id="politicas-volver">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA: ACTUALIZACI√ìN COMERCIO -->
    <section id="view-actualiza" class="view">
      <div class="card">
        <h2 style="color:var(--primary)">Actualiza tus Datos</h2>
        <div class="narrow">
          <input id="upd-documento" type="hidden" />

          <!-- Misma estructura del formulario, todos opcionales -->
          <label>Categor√≠a de tu Comercio</label>
          <p class="desc">Selecciona si deseas cambiar la categor√≠a.</p>
          <select id="upd-categoria">
            <option value="" selected>Sin cambios</option>
          </select>

          <label>Especificaciones</label>
          <p class="desc">Se actualiza al elegir categor√≠a. Solo lectura.</p>
          <textarea id="upd-especificaciones" rows="5" readonly placeholder="Selecciona categor√≠a para ver especificaciones"></textarea>

          <label>Nombre del Comercio</label>
          <p class="desc">Opcional. D√©jalo vac√≠o si no cambiar√°s.</p>
          <input id="upd-nombre" type="text" placeholder="Sin cambios" />

          <label>Descripci√≥n del Comercio</label>
          <p class="desc">Opcional.</p>
          <textarea id="upd-descripcion" rows="3" placeholder="Sin cambios"></textarea>

          <label>Imagen del Comercio</label>
          <p class="desc">Opcional. Si subes una imagen, reemplazar√° la actual.</p>
          <input type="file" id="upd-foto" accept="image/*">
          <img id="upd-preview" src="" alt="Vista previa" style="display:none; max-width:100%; border-radius:10px; border:1px solid #ddd; margin-top:8px;" />

          <label>Direcci√≥n del Comercio</label>
          <p class="desc">Opcional.</p>
          <input id="upd-direccion" type="text" placeholder="Sin cambios" />

          <label>Ubicaci√≥n del Comercio</label>
          <p class="desc">Opcional.</p>
          <div class="input-with-icon">
            <input id="upd-ubicacion" type="url" placeholder="https://maps.app.goo.gl/..." />
            <a id="mapsLink2" class="icon-btn" href="#" target="_blank" rel="noopener" title="Instalar/Abrir Google Maps">
              <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1760108968/ubicacion_zicnod.png" alt="Maps">
            </a>
          </div>

          <label>Oferta del Comercio</label>
          <p class="desc">Opcional.</p>
          <textarea id="upd-oferta" rows="3" placeholder="Sin cambios"></textarea>

          <label>Facebook</label>
          <p class="desc">Opcional.</p>
          <div class="input-with-icon">
            <input id="upd-facebook" type="url" placeholder="https://www.facebook.com/share/..." />
            <a id="facebookLink2" class="icon-btn" href="#" target="_blank" rel="noopener" title="Instalar/Abrir Facebook">
              <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1759166342/facebook_nezbkz.webp" alt="Facebook">
            </a>
          </div>

          <label>Instagram</label>
          <p class="desc">Opcional.</p>
          <div class="input-with-icon">
            <input id="upd-instagram" type="url" placeholder="https://www.instagram.com/tuusuario" />
            <a id="instagramLink2" class="icon-btn" href="#" target="_blank" rel="noopener" title="Instalar/Abrir Instagram">
              <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1759166342/instragram_uft2wl.webp" alt="Instagram">
            </a>
          </div>

          <label>TikTok</label>
          <p class="desc">Opcional.</p>
          <div class="input-with-icon">
            <input id="upd-tiktok" type="url" placeholder="https://www.tiktok.com/@usuario..." />
            <a id="tiktokLink2" class="icon-btn" href="#" target="_blank" rel="noopener" title="Instalar/Abrir TikTok">
              <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1759166342/tiktok_tdvc2x.webp" alt="TikTok">
            </a>
          </div>

          <label>WhatsApp</label>
          <p class="desc">Opcional. Solo d√≠gitos (10).</p>
          <input id="upd-whatsapp" type="tel" inputmode="numeric" placeholder="Sin cambios" />

          <label>Tel√©fono</label>
          <p class="desc">Opcional.</p>
          <input id="upd-telefono" type="tel" inputmode="numeric" placeholder="Sin cambios" />

          <div class="btn-row" style="margin-top:14px;">
            <button class="btn-primary" id="btn-guardar-actualiza">Guardar</button>
            <button id="btn-actualiza-volver">Regresar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- VISTA: VALIDAR USUARIO (PRINCIPAL) -->
    <section id="view-validar" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">Validar Usuario</h2>
        <label>Documento</label>
        <p class="desc">Ingresa el documento del usuario (sin puntos ni espacios).</p>
        <input id="val-documento" type="tel" inputmode="numeric" placeholder="Documento" />
        <div class="btn-row" style="margin-top:12px;">
          <button class="btn-primary" id="btn-validar-usuario">Validar</button>
          <button id="btn-validar-volver">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA: INSTALAR APP (como referencia) -->
    <section id="view-instalar" class="view">
      <div class="install-wrap">
        <h2 style="color:var(--primary); text-shadow: 0 2px 2px #031732; margin: 0 0 8px;">PORTAL COMERCIAL</h2>
        <img class="brand" alt="App" src="https://res.cloudinary.com/dqqeavica/image/upload/v1759696513/Jhonny_y1tslf.gif" />
        <p class="tagline">#SoyDeFlandes</p>
        <p class="tagline">#NoParamos</p>
        <p class="tagline">#SiemprePresentes</p>
        <div class="btn-row spaced" style="max-width:420px; width:100%; justify-content:center;">
          <button class="btn-primary" id="btn-instalar-standalone">Instalar la App üì≤</button>
        </div>
      </div>
    </section>

  </div>

  <script>
    // URL de tu Apps Script desplegado (el nuevo para Portal Comercial)
    const API_BASE = 'https://script.google.com/macros/s/AKfycbx3HZ2jHN6P0-TOAfNfvzYJYPfRMzR-pK7kSrbWxmH8eUlo_AlZae85kv2Kietxv-M/exec';

    // Sonidos
    const SOUNDS = {
      question: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_fail_ls2aif.mp3',
      info: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Default_notification_pkp4wr.mp3',
      success: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_success_t5aawh.mp3',
      error: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
      warning: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
      resumen: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Charging_clkgcd.mp3',
      login: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_star_g1owy4.mp3',
      logout: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_End_kelv02.mp3',
      menu: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Namedrop_Popup_ale2zy.mp3',
      back: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Keyboard_Enter_b9k2dc.mp3'
    };
    function playSoundOnce(url){ try{ const a = new Audio(url); a.preload='auto'; a.play().catch(()=>{}); }catch(_){ } }
    if (window.Swal && typeof Swal.fire === 'function'){
      const __fire = Swal.fire.bind(Swal);
      Swal.fire = function(options = {}, ...rest){
        try{
          if (options.soundTag === 'resumen'){ playSoundOnce(SOUNDS.resumen); }
          else{ const icon = options.icon || options.type; if (icon && SOUNDS[icon]) playSoundOnce(SOUNDS[icon]); }
        }catch(_){}
        return __fire(options, ...rest);
      }
    }

    // Loader
    const loader = document.getElementById('loader');
    let loadingCount = 0, loaderTimer = null;
    function startLoading(){
      loadingCount++;
      if (loadingCount === 1){
        loaderTimer = setTimeout(()=>{ loader.classList.remove('hidden'); loaderTimer=null; }, 120);
      }
    }
    function stopLoading(){
      if (loadingCount === 0) return;
      loadingCount--;
      if (loadingCount === 0){
        if (loaderTimer){ clearTimeout(loaderTimer); loaderTimer=null; }
        loader.classList.add('hidden');
      }
    }

    // Fetch helpers
    async function apiGet(action, params = {}){
      startLoading();
      try{
        const url = new URL(API_BASE);
        url.search = new URLSearchParams({ action, ...params }).toString();
        const r = await fetch(url.toString(), { method: 'GET' });
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || 'Error');
        return j.data;
      } finally { stopLoading(); }
    }
    async function apiPost(action, body = {}){
      startLoading();
      try{
        const url = API_BASE + '?action=' + encodeURIComponent(action);
        const r = await fetch(url, {
          method:'POST',
          headers: { 'Content-Type':'text/plain;charset=utf-8' },
          body: JSON.stringify(body)
        });
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || 'Error');
        return j.data;
      } finally { stopLoading(); }
    }

    // Estado Comercio
    let currentComercio = null;

    // Vistas
    function showView(id){
      document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
      document.getElementById(id)?.classList.add('active');
      overlay.classList.remove('open');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Choices para selects
    let choicesRegCat = null, choicesUpdCat = null;
    function initChoicesSelects(){
      const selR = document.getElementById('reg-categoria');
      if (choicesRegCat) { try{ choicesRegCat.destroy(); }catch(_){ } choicesRegCat = null; }
      if (selR){
        choicesRegCat = new Choices(selR, {
          searchEnabled: true, itemSelectText: '', shouldSort:true,
          placeholder: true, placeholderValue: 'Selecciona tu Categor√≠a',
          searchPlaceholderValue: 'Escribe para filtrar'
        });
      }
      const selU = document.getElementById('upd-categoria');
      if (choicesUpdCat) { try{ choicesUpdCat.destroy(); }catch(_){ } choicesUpdCat = null; }
      if (selU){
        choicesUpdCat = new Choices(selU, {
          searchEnabled: true, itemSelectText: '', shouldSort:true,
          placeholder: true, placeholderValue: 'Sin cambios',
          searchPlaceholderValue: 'Escribe para filtrar'
        });
      }
    }
    document.addEventListener('DOMContentLoaded', initChoicesSelects);

    // Categor√≠as -> Especificaciones
    const CATEGORIAS = [
      { cat: 'Alimentos y Bebidas', spec: 'Restaurantes familiares, Comidas r√°pidas, Cafeter√≠as, Panader√≠as, Helader√≠as, Juguer√≠as, Fruter√≠as, Pizzer√≠as, Asaderos, Tiendas naturistas, Productos saludables, Venta ambulante de comidas, Corrientazos, Venta de jugos, Empanadas, Arepas, Bu√±uelos, Chorizos, Pinchos, Mazorcas, Venta de Cerveza' },
      { cat: 'Belleza, Cuidado Personal y Est√©tica', spec: 'Peluquer√≠as, Barber√≠as, Manicure, Pedicure, U√±as acr√≠licas, Spa de manos y pies, Centros de est√©tica, Depilaci√≥n, Maquillaje profesional, Venta de cosm√©ticos, Perfumer√≠as, Masajes, Terapias relajantes' },
      { cat: 'Ropa, Calzado y Accesorios', spec: 'Boutiques de ropa, Tiendas de ropa deportiva, Tiendas de ropa infantil, Zapater√≠as, Joyer√≠as, Relojer√≠as, Tiendas de bolsos, Tiendas de gorras, Gafas, Bisuter√≠a, Venta de ropa usada, Venta ambulante de accesorios, Ventas por cat√°logo, Ventas por redes sociales' },
      { cat: 'Hogar, Decoraci√≥n y Muebles', spec: 'Tiendas de muebles, Tiendas de colchones, Ferreter√≠as, Vidrier√≠as, Tiendas de decoraci√≥n, Art√≠culos de hogar, Cerrajer√≠as, Electricistas, Plomeros' },
      { cat: 'Tecnolog√≠a y Comunicaci√≥n', spec: 'Tiendas de celulares, Accesorios para celulares, Reparaci√≥n de celulares, Venta de computadores, Reparaci√≥n de computadores, Cabinas de internet, Papeler√≠as tecnol√≥gicas, Venta de planes m√≥viles, Recargas, Impresiones, Fotocopias' },
      { cat: 'Construcci√≥n y Materiales', spec: 'Ferreter√≠as, Materiales de construcci√≥n, Pintura, Acabados, Plomer√≠a, Electricidad, Carpinter√≠a, Alba√±iler√≠a, Venta de ladrillos, Cemento, Tejas, Arena' },
      { cat: 'Automotores y Transporte', spec: 'Talleres mec√°nicos, Talleres el√©ctricos, Lavaderos de carros, Lavaderos de motos, Venta de repuestos, Venta de llantas, Estaciones de servicio, Gasolineras, Mototaxismo, Transporte informal, Transporte urbano, Transporte rural' },
      { cat: 'Salud y Bienestar', spec: 'Droguer√≠as, Farmacias, Consultorios m√©dicos, Odontolog√≠a, √ìpticas, Veterinarias, Tiendas naturistas, Productos fitoterap√©uticos, Fisioterapia, Terapias alternativas' },
      { cat: 'Educaci√≥n y Servicios Profesionales', spec: 'Instituciones educativas privadas, Guarder√≠as, Academias de m√∫sica, Academias de danza, Academias de idiomas, Academias de artes, Profesores particulares, Servicios contables, Servicios jur√≠dicos, Consultor√≠as empresariales' },
      { cat: 'Arte, Cultura y Entretenimiento', spec: 'Tiendas de instrumentos musicales, Academias art√≠sticas, Bares, Discotecas, Tabernas, Salones de eventos, Salones de fiestas, Grupos musicales, Orquestas, DJs, Emprendimientos culturales, Turismo cultural' },
      { cat: 'Agropecuario y Rural', spec: 'Insumos agr√≠colas, Insumos veterinarios, Compra de ganado, Venta de ganado, Fincas productoras, Productos agr√≠colas, Ventas campesinas, Frutas, Verduras, Huevos, Maquinaria agr√≠cola, Abonos' },
      { cat: 'Servicios Financieros y Administrativos', spec: 'Bancos, Cooperativas, Casas de cambio, Giros, Remesas, Tramitadores, Notar√≠as, Oficinas jur√≠dicas, Servicios contables, Servicios administrativos' },
      { cat: 'Comercio General y Miscel√°neas', spec: 'Tiendas de barrio, Supermercados, Minimercados, Miscel√°neas, Tiendas de variedades, Tiendas todo a mil, Ventas ambulantes, Ventas por cat√°logo, Ventas por redes sociales' },
      { cat: 'Turismo, Alojamiento y Recreaci√≥n', spec: 'Hoteles, Hostales, Residencias, Agencias de viajes, Gu√≠as tur√≠sticos, Balnearios, Parques recreativos, Alquiler de bicicletas, Alquiler de cuatrimotos, Artesan√≠as, Recuerdos locales' },
      { cat: 'Mascotas y Animales', spec: 'Tiendas de mascotas, Peluquer√≠a canina, Venta de alimentos para mascotas, Venta de accesorios para mascotas, Veterinarias, Vacunaci√≥n' },
      { cat: 'Limpieza, Mantenimiento y Servicios Dom√©sticos', spec: 'Lavander√≠as, Tintorer√≠as, Aseo de casas, Aseo de oficinas, Venta de productos de limpieza, Jardiner√≠a, Fumigaci√≥n' },
      { cat: 'Reparaciones y Servicios T√©cnicos', spec: 'Reparaci√≥n de electrodom√©sticos, Talleres de motos, Talleres de bicicletas, Cerrajer√≠a, Soldadura, Carpinter√≠a, Modister√≠a, Arreglos de ropa' },
      { cat: 'Otros servicios comunes', spec: 'Venta de minutos, Recargas, Loter√≠as, Chance, Venta de ropa puerta a puerta, Bisuter√≠a artesanal, Fotograf√≠a m√≥vil, Servicios de mensajer√≠a, Mandados, Venta de tintos, Venta de cigarrillos' }
    ];
    function fillCategoriaSelects(){
      const r = document.getElementById('reg-categoria');
      const u = document.getElementById('upd-categoria');
      if (r){
        r.innerHTML = '<option value="" disabled selected>Selecciona tu Categor√≠a</option>';
        for(const it of CATEGORIAS){
          const op = document.createElement('option'); op.value = it.cat; op.textContent = it.cat; r.appendChild(op);
        }
      }
      if (u){
        u.innerHTML = '<option value="" selected>Sin cambios</option>';
        for(const it of CATEGORIAS){
          const op = document.createElement('option'); op.value = it.cat; op.textContent = it.cat; u.appendChild(op);
        }
      }
      initChoicesSelects();
    }
    document.addEventListener('DOMContentLoaded', fillCategoriaSelects);

    function specFor(cat){ const f = CATEGORIAS.find(x => x.cat === cat); return f ? f.spec : ''; }

    // Smart links (Maps, FB, IG, TikTok)
    (function setSmartLinks(){
      const ua = navigator.userAgent || navigator.vendor || window.opera || '';
      const isAndroid = /android/i.test(ua);
      const links = {
        maps:      { android:'https://play.google.com/store/apps/details?id=com.google.android.apps.maps', ios:'https://apps.apple.com/app/google-maps/id585027354' },
        facebook:  { android:'https://play.google.com/store/apps/details?id=com.facebook.katana',         ios:'https://apps.apple.com/app/facebook/id284882215' },
        instagram: { android:'https://play.google.com/store/apps/details?id=com.instagram.android',       ios:'https://apps.apple.com/app/instagram/id389801252' },
        tiktok:    { android:'https://play.google.com/store/apps/details?id=com.zhiliaoapp.musically',    ios:'https://apps.apple.com/app/tiktok/id835599320' }
      };
      const set = (id, pair) => { const el = document.getElementById(id); if (el) el.href = isAndroid ? pair.android : pair.ios; };
      ['mapsLink','facebookLink','instagramLink','tiktokLink','mapsLink2','facebookLink2','instagramLink2','tiktokLink2']
        .forEach((id)=>{
          const key = id.includes('maps')?'maps':id.includes('facebook')?'facebook':id.includes('instagram')?'instagram':'tiktok';
          set(id, links[key]);
        });
    })();

    // Previsualizaci√≥n y base64 de im√°genes
    let regFotoDataUrl = '';
    document.getElementById('reg-foto')?.addEventListener('change', function(e){
      const file = e.target.files && e.target.files[0];
      const preview = document.getElementById('reg-preview');
      if (file){
        const reader = new FileReader();
        reader.onload = ev => { regFotoDataUrl = ev.target.result; preview.src = regFotoDataUrl; preview.style.display = 'block'; };
        reader.readAsDataURL(file);
      }else{ regFotoDataUrl=''; preview.src=''; preview.style.display='none'; }
    });
    let updFotoDataUrl = '';
    document.getElementById('upd-foto')?.addEventListener('change', function(e){
      const file = e.target.files && e.target.files[0];
      const preview = document.getElementById('upd-preview');
      if (file){
        const reader = new FileReader();
        reader.onload = ev => { updFotoDataUrl = ev.target.result; preview.src = updFotoDataUrl; preview.style.display = 'block'; };
        reader.readAsDataURL(file);
      }else{ updFotoDataUrl=''; preview.src=''; preview.style.display='none'; }
    });

    // Helpers imagen estilo "Comerciantes"
    function driveThumb(url){
      const m = String(url||'').match(/[-\w]{25,}/);
      return m ? `https://drive.google.com/thumbnail?sz=w1000&id=${m[0]}` : String(url||'');
    }
    function toDisplayImage(src){
      if (!src) return '';
      if (/^data:/i.test(src)) return src;        // optimista base64
      return driveThumb(src);                      // Drive -> miniatura
    }
    function setAvatar(src){
      const img = document.getElementById('c-thumb');
      const fallback = 'https://res.cloudinary.com/dqqeavica/image/upload/v1759798601/noticias_dax8sd.jpg';
      img.loading = 'lazy';
      img.src = toDisplayImage(src) || fallback;
      img.onerror = ()=>{ img.src = fallback; };
    }

    // Video
    const videoCard = document.getElementById('videoCard');
    const playLayer = document.getElementById('playLayer');
    const videoThumb = document.getElementById('videoThumb');
    let currentVideo = null;
    function playVideo(){
      if (videoCard.querySelector('video')) return;
      const src = 'https://res.cloudinary.com/dqqeavica/video/upload/v1759803503/Bienvenida_d0q2bs.mp4';
      const video = document.createElement('video');
      video.src = src; video.autoplay = true; video.muted = false; video.playsInline = true; video.controls = true; video.preload = 'auto';
      if (videoThumb && videoThumb.src) video.poster = videoThumb.src;
      video.style.width='100%'; video.style.height='100%'; video.style.objectFit='cover';
      videoCard.appendChild(video);
      videoCard.classList.add('playing');
      currentVideo = video;
      const p = video.play();
      if (p && typeof p.then === 'function'){ p.catch(()=>{ video.muted=true; video.play().catch(()=>{}); }); }
      video.addEventListener('ended', stopVideoPlayback);
    }
    function stopVideoPlayback(){
      const v = currentVideo || videoCard.querySelector('video');
      if (!v){ videoCard.classList.remove('playing'); return; }
      try{ v.pause(); v.removeAttribute('src'); v.load(); }catch(_){}
      v.remove(); currentVideo=null; videoCard.classList.remove('playing');
    }
    playLayer?.addEventListener('click', playVideo);
    videoThumb?.addEventListener('click', playVideo);
    document.addEventListener('visibilitychange', ()=>{ if (document.hidden) stopVideoPlayback(); });

    // Men√∫ lateral
    const overlay = document.getElementById('overlay');
    document.getElementById('btn-open-menu')?.addEventListener('click', ()=>{ playSoundOnce(SOUNDS.menu); overlay.classList.add('open'); });
    document.getElementById('btn-ovl-back')?.addEventListener('click', ()=> overlay.classList.remove('open'));
    document.getElementById('ovlClose')?.addEventListener('click', ()=> overlay.classList.remove('open'));

    // Volver botones con sonido
    ['btn-reg-atras','politicas-volver','btn-actualiza-volver','btn-validar-volver'].forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.addEventListener('click', ()=> playSoundOnce(SOUNDS.back));
    });

    // Compartir
    document.getElementById('btn-compartir')?.addEventListener('click', ()=>{
      const url = "https://tinyurl.com/app-jhonny-perdomo";
      const txt = "Instala la App üì≤ y reg√≠strate en el PORTAL COMERCIAL:\n" + url;
      if(navigator.clipboard){ navigator.clipboard.writeText(txt).catch(()=>{}); }
      const enc = encodeURIComponent(txt);
      const esMovil = /android|iphone|ipad|mobile/i.test(navigator.userAgent||'');
      window.open((esMovil ? "whatsapp://send?text=" : "https://api.whatsapp.com/send?text=") + enc, "_blank");
    });

    // Especificaciones onChange
    document.getElementById('reg-categoria')?.addEventListener('change', (e)=>{
      document.getElementById('reg-especificaciones').value = specFor(e.target.value) || '';
    });
    document.getElementById('upd-categoria')?.addEventListener('change', (e)=>{
      document.getElementById('upd-especificaciones').value = specFor(e.target.value) || '';
    });

    // Render men√∫ comercio
    function renderMenuComercio(){
      const d = currentComercio || {};
      setAvatar(d.imagen);
      const nameEl = document.getElementById('c-nombre');
      nameEl.textContent = d.nombre || '';
      document.getElementById('c-estado').textContent = d.estado || '';
      document.getElementById('c-direccion').textContent = d.direccion || '';
      document.getElementById('c-nit').textContent = d.documento || '';
      document.getElementById('c-categoria').textContent = d.categoria || '';
      document.getElementById('c-descripcion').textContent = d.descripcion || '';
      document.getElementById('c-oferta').textContent = d.oferta || '';
      document.getElementById('c-whatsapp').textContent = d.whatsapp || '';
    }

    // Reconsultar comercio tras cambios
    async function refreshComercioFromServer(){
      try{
        const doc = currentComercio?.documento;
        if(!doc) return;
        const res = await apiGet('validarDocumento', { documento: doc });
        if(res?.existe){
          currentComercio = {
            documento: res.documento,
            categoria: res.categoria || '',
            especificaciones: res.especificaciones || '',
            nombre: res.nombre || '',
            descripcion: res.descripcion || '',
            imagen: res.imagen || '',
            oferta: res.oferta || '',
            direccion: res.direccion || '',
            ubicacion: res.ubicacion || '',
            facebook: res.facebook || '',
            instagram: res.instagram || '',
            tiktok: res.tiktok || '',
            whatsapp: res.whatsapp || '',
            telefono: res.telefono || '',
            estado: res.estado || ''
          };
          renderMenuComercio();
        }
      }catch(_){}
    }

    // Validadores
    const docRegex = /^(?:[0-9]{6,9}|1[0-9]{9})$/;
    const waRegex = /^[0-9]{10}$/;
    const urlMapsOk = (u)=> /^https:\/\/(maps\.app\.goo\.gl|goo\.gl\/maps|www\.google\.[^\/]+\/maps)/i.test(u);
    const urlFacebookOk = (u)=> /^https:\/\/(www\.)?facebook\.com\//i.test(u);
    const urlInstagramOk = (u)=> /^https:\/\/(www\.)?instagram\.com\//i.test(u);
    const urlTiktokOk = (u)=> /^https:\/\/(www\.)?tiktok\.com\/@/i.test(u);

    // LOGIN
    const btnLogin = document.getElementById('btn-login');
    const docLogin = document.getElementById('doc-login');
    const regCard = document.getElementById('registro-card');

    btnLogin?.addEventListener('click', async ()=>{
      const documento = (docLogin.value || '').trim();
      if (documento === ''){
        return Swal.fire({ icon:'question', title:'¬øDeseas comenzar?', text:'Ingresa un Documento para validar.', timer:3000 });
      }
      if (!docRegex.test(documento)){
        return Swal.fire({ icon:'warning', title:'Documento inv√°lido', text:'Ingresa de 6 a 10 d√≠gitos.' });
      }

      try{
        const [res, est] = await Promise.all([
          apiGet('validarDocumento', { documento }),
          apiGet('validarestado', { documento })
        ]);

        if (res && res.existe){
          const estado = String(est?.estado || '').toUpperCase();
          if (estado === 'INACTIVO'){
            await Swal.fire({ icon:'info', title:'No tienes acceso', text:'Tu Comercio est√° INACTIVO. Ac√©rcate a nuestra sede para verificaci√≥n.', timer:5000, showConfirmButton:false });
            return;
          }

          currentComercio = {
            documento: res.documento,
            categoria: res.categoria || '',
            especificaciones: res.especificaciones || '',
            nombre: res.nombre || '',
            descripcion: res.descripcion || '',
            imagen: res.imagen || '',
            oferta: res.oferta || '',
            direccion: res.direccion || '',
            ubicacion: res.ubicacion || '',
            facebook: res.facebook || '',
            instagram: res.instagram || '',
            tiktok: res.tiktok || '',
            whatsapp: res.whatsapp || '',
            telefono: res.telefono || '',
            estado: est?.estado || res.estado || ''
          };
          renderMenuComercio();
          playSoundOnce(SOUNDS.login);
          showView('view-menu');
        }else{
          regCard.style.display = '';
          Swal.fire({ icon:'info', title:'Nuevo Comercio', text:'Completa tu registro para continuar.' });
        }

      }catch(e){
        Swal.fire({ icon:'error', title:'Error', text:e.message });
      }
    });

    // Atr√°s registro -> login
    document.getElementById('btn-reg-atras')?.addEventListener('click', (e)=>{
      e.preventDefault();
      regCard.style.display='none';
      showView('view-login');
    });

    // Guardar Registro (optimista)
    document.getElementById('btn-guardar-registro')?.addEventListener('click', async ()=>{
      const documento = (docLogin.value || '').trim();
      const categoria = (document.getElementById('reg-categoria').value || '').trim();
      const especificaciones = (document.getElementById('reg-especificaciones').value || '').trim();
      const nombre = (document.getElementById('reg-nombre').value || '').trim();
      const descripcion = (document.getElementById('reg-descripcion').value || '').trim();
      const direccion = (document.getElementById('reg-direccion').value || '').trim();
      const ubicacion = (document.getElementById('reg-ubicacion').value || '').trim();
      const oferta = (document.getElementById('reg-oferta').value || '').trim();
      const facebook = (document.getElementById('reg-facebook').value || '').trim();
      const instagram = (document.getElementById('reg-instagram').value || '').trim();
      const tiktok = (document.getElementById('reg-tiktok').value || '').trim();
      const whatsapp = (document.getElementById('reg-whatsapp').value || '').trim();
      const telefono = (document.getElementById('reg-telefono').value || '').trim();

      if (!docRegex.test(documento)){ return Swal.fire({ icon:'warning', title:'Documento inv√°lido' }); }
      if (!categoria){ return Swal.fire({ icon:'warning', title:'Categor√≠a requerida' }); }
      if (!nombre){ return Swal.fire({ icon:'warning', title:'Nombre requerido' }); }
      if (!descripcion){ return Swal.fire({ icon:'warning', title:'Descripci√≥n requerida' }); }
      if (!regFotoDataUrl){ return Swal.fire({ icon:'warning', title:'Imagen requerida' }); }
      if (!direccion){ return Swal.fire({ icon:'warning', title:'Direcci√≥n requerida' }); }
      if (!oferta){ return Swal.fire({ icon:'warning', title:'Oferta requerida' }); }
      if (!waRegex.test(whatsapp)){ return Swal.fire({ icon:'warning', title:'WhatsApp inv√°lido', text:'Debe tener 10 d√≠gitos.' }); }
      if (ubicacion && !urlMapsOk(ubicacion)) return Swal.fire({ icon:'warning', title:'Ubicaci√≥n inv√°lida' });
      if (facebook && !urlFacebookOk(facebook)) return Swal.fire({ icon:'warning', title:'Facebook inv√°lido' });
      if (instagram && !urlInstagramOk(instagram)) return Swal.fire({ icon:'warning', title:'Instagram inv√°lido' });
      if (tiktok && !urlTiktokOk(tiktok)) return Swal.fire({ icon:'warning', title:'TikTok inv√°lido' });

      const resumenHtml = `
        <b>NIT/Documento:</b> ${documento}<br>
        <b>Categor√≠a:</b> ${categoria}<br>
        <b>Nombre:</b> ${nombre}<br>
        <b>Descripci√≥n:</b> ${descripcion}<br>
        <b>Direcci√≥n:</b> ${direccion}<br>
        <b>Ubicaci√≥n:</b> ${ubicacion || 'Sin Registro'}<br>
        <b>Oferta:</b> ${oferta}<br>
        <b>Facebook:</b> ${facebook || 'Sin Registro'}<br>
        <b>Instagram:</b> ${instagram || 'Sin Registro'}<br>
        <b>TikTok:</b> ${tiktok || 'Sin Registro'}<br>
        <b>WhatsApp:</b> ${whatsapp}<br>
        <b>Tel√©fono:</b> ${telefono || 'Sin Registro'}<br><br>
        <img class="brand" src="https://res.cloudinary.com/dqqeavica/image/upload/v1753538919/BANNER_JHONNY_e0yw7m.png" alt="">
      `;
      const rs = await Swal.fire({
        icon:'info', title:'Resumen de Registro', html:resumenHtml,
        showCancelButton:true, confirmButtonText:'Confirmar', cancelButtonText:'Editar',
        width:'80%', soundTag:'resumen'
      });
      if (!rs.isConfirmed) return;

      const opt = (v)=> v ? v : ' ';

      try{
        const payload = {
          documento, categoria, especificaciones, nombre, descripcion,
          foto: regFotoDataUrl, urlImagen: '',
          direccion, ubicacion: opt(ubicacion), oferta,
          facebook: opt(facebook), instagram: opt(instagram), tiktok: opt(tiktok),
          whatsapp, telefono: opt(telefono)
        };
        const r = await apiPost('guardarComercioEnServidor', payload);
        if (r && r.success){
          currentComercio = {
            documento, categoria, especificaciones, nombre, descripcion,
            imagen: regFotoDataUrl, oferta, direccion,
            ubicacion: opt(ubicacion), facebook: opt(facebook), instagram: opt(instagram), tiktok: opt(tiktok),
            whatsapp, telefono: opt(telefono), estado: 'ACTIVO'
          };
          renderMenuComercio();
          playSoundOnce(SOUNDS.login);
          regCard.style.display='none';
          showView('view-menu');
          refreshComercioFromServer(); // trae URL real de Drive
        }else{
          Swal.fire({ icon:'error', title:'Error al guardar', html:r?.message || 'Error desconocido' });
        }
      }catch(e){
        Swal.fire({ icon:'error', title:'Error', text:e.message });
      }
    });

    // Logout
    document.getElementById('btn-logout')?.addEventListener('click', ()=>{
      playSoundOnce(SOUNDS.logout);
      currentComercio = null;
      docLogin.value = '';
      document.getElementById('registro-card').style.display='none';
      stopVideoPlayback();
      showView('view-login');
    });

    // Navegaci√≥n Overlay a vistas
    document.getElementById('go-politicas')?.addEventListener('click', ()=>{ overlay.classList.remove('open'); showView('view-politicas'); });
    document.getElementById('go-actualiza')?.addEventListener('click', async ()=>{
      overlay.classList.remove('open');
      await prepararActualiza();
      showView('view-actualiza');
    });
    document.getElementById('go-validar')?.addEventListener('click', ()=>{ overlay.classList.remove('open'); showView('view-validar'); });
    document.getElementById('go-descargar')?.addEventListener('click', ()=>{
      overlay.classList.remove('open');
      window.open('https://tinyurl.com/app-jhonny-perdomo', '_blank');
    });

    // Volver gen√©ricos
    document.getElementById('politicas-volver')?.addEventListener('click', ()=> showView('view-menu'));
    document.getElementById('btn-actualiza-volver')?.addEventListener('click', ()=> showView('view-menu'));
    document.getElementById('btn-validar-volver')?.addEventListener('click', ()=> showView('view-menu'));

    // Preparar actualizaci√≥n
    async function prepararActualiza(){
      if(!currentComercio) return;
      document.getElementById('upd-documento').value = currentComercio.documento || '';
      ['upd-categoria','upd-especificaciones','upd-nombre','upd-descripcion','upd-direccion','upd-ubicacion','upd-oferta','upd-facebook','upd-instagram','upd-tiktok','upd-whatsapp','upd-telefono']
        .forEach(id=>{ const el = document.getElementById(id); if(!el) return; el.value = ''; });
      if (choicesUpdCat) choicesUpdCat.setChoiceByValue('');
      updFotoDataUrl=''; const p = document.getElementById('upd-preview'); if (p){ p.src=''; p.style.display='none'; }
    }

    // Guardar actualizaci√≥n (optimista)
    document.getElementById('btn-guardar-actualiza')?.addEventListener('click', async ()=>{
      const documento = (document.getElementById('upd-documento').value || '').trim();
      if (!docRegex.test(documento)) return Swal.fire({ icon:'warning', title:'Documento inv√°lido' });

      const categoria = (document.getElementById('upd-categoria').value || '').trim();
      const especificaciones = (document.getElementById('upd-especificaciones').value || '').trim();
      const nombre = (document.getElementById('upd-nombre').value || '').trim();
      const descripcion = (document.getElementById('upd-descripcion').value || '').trim();
      const direccion = (document.getElementById('upd-direccion').value || '').trim();
      const ubicacion = (document.getElementById('upd-ubicacion').value || '').trim();
      const oferta = (document.getElementById('upd-oferta').value || '').trim();
      const facebook = (document.getElementById('upd-facebook').value || '').trim();
      const instagram = (document.getElementById('upd-instagram').value || '').trim();
      const tiktok = (document.getElementById('upd-tiktok').value || '').trim();
      const whatsapp = (document.getElementById('upd-whatsapp').value || '').trim();
      const telefono = (document.getElementById('upd-telefono').value || '').trim();

      if (whatsapp && !/^[0-9]{10}$/.test(whatsapp)) return Swal.fire({ icon:'warning', title:'WhatsApp inv√°lido' });
      if (ubicacion && !urlMapsOk(ubicacion)) return Swal.fire({ icon:'warning', title:'Ubicaci√≥n inv√°lida' });
      if (facebook && !urlFacebookOk(facebook)) return Swal.fire({ icon:'warning', title:'Facebook inv√°lido' });
      if (instagram && !urlInstagramOk(instagram)) return Swal.fire({ icon:'warning', title:'Instagram inv√°lido' });
      if (tiktok && !urlTiktokOk(tiktok)) return Swal.fire({ icon:'warning', title:'TikTok inv√°lido' });

      const resumenHtml = `
        <b>NIT/Documento:</b> ${documento}<br>
        <b>Categor√≠a:</b> ${categoria || 'Sin cambios'}<br>
        <b>Nombre:</b> ${nombre || 'Sin cambios'}<br>
        <b>Descripci√≥n:</b> ${descripcion || 'Sin cambios'}<br>
        <b>Direcci√≥n:</b> ${direccion || 'Sin cambios'}<br>
        <b>Ubicaci√≥n:</b> ${ubicacion || 'Sin cambios'}<br>
        <b>Oferta:</b> ${oferta || 'Sin cambios'}<br>
        <b>Facebook:</b> ${facebook || 'Sin cambios'}<br>
        <b>Instagram:</b> ${instagram || 'Sin cambios'}<br>
        <b>TikTok:</b> ${tiktok || 'Sin cambios'}<br>
        <b>WhatsApp:</b> ${whatsapp || 'Sin cambios'}<br>
        <b>Tel√©fono:</b> ${telefono || 'Sin cambios'}<br><br>
        <img class="brand" src="https://res.cloudinary.com/dqqeavica/image/upload/v1753538919/BANNER_JHONNY_e0yw7m.png" alt="">
      `;
      const rs = await Swal.fire({
        icon:'info', title:'Resumen de Actualizaci√≥n', html:resumenHtml,
        showCancelButton:true, confirmButtonText:'Confirmar', cancelButtonText:'Editar',
        width:'80%', soundTag:'resumen'
      });
      if (!rs.isConfirmed) return;

      const body = { documento };
      if (categoria) { body.categoria = categoria; body.especificaciones = especificaciones || specFor(categoria) || ' '; }
      if (nombre) body.nombre = nombre;
      if (descripcion) body.descripcion = descripcion;
      if (direccion) body.direccion = direccion;
      if (ubicacion) body.ubicacion = ubicacion;
      if (oferta) body.oferta = oferta;
      if (facebook) body.facebook = facebook;
      if (instagram) body.instagram = instagram;
      if (tiktok) body.tiktok = tiktok;
      if (whatsapp) body.whatsapp = whatsapp;
      if (telefono) body.telefono = telefono;
      if (updFotoDataUrl) body.foto = updFotoDataUrl;

      try{
        const r = await apiPost('actualizarComercioEnServidor', body);
        if (r && r.success){
          if (!currentComercio) currentComercio = { documento };
          if (categoria){ currentComercio.categoria = categoria; currentComercio.especificaciones = especificaciones || specFor(categoria) || currentComercio.especificaciones || ''; }
          if (nombre) currentComercio.nombre = nombre;
          if (descripcion) currentComercio.descripcion = descripcion;
          if (direccion) currentComercio.direccion = direccion;
          if (ubicacion) currentComercio.ubicacion = ubicacion;
          if (oferta) currentComercio.oferta = oferta;
          if (facebook) currentComercio.facebook = facebook;
          if (instagram) currentComercio.instagram = instagram;
          if (tiktok) currentComercio.tiktok = tiktok;
          if (whatsapp) currentComercio.whatsapp = whatsapp;
          if (telefono) currentComercio.telefono = telefono;
          if (updFotoDataUrl) currentComercio.imagen = updFotoDataUrl; // optimista
          renderMenuComercio();

          await Swal.fire({ icon:'success', title:'Actualizaci√≥n exitosa', timer:1200, showConfirmButton:false });
          refreshComercioFromServer(); // traer URL de Drive y refrescar avatar
          showView('view-menu');
        }else{
          Swal.fire({ icon:'error', title:'Error al guardar', text:r?.message || 'Error desconocido' });
        }
      }catch(e){
        Swal.fire({ icon:'error', title:'Error', text:e.message });
      }
    });

    // Validar Usuario (PRINCIPAL)
    document.getElementById('btn-validar-usuario')?.addEventListener('click', async ()=>{
      const documento = (document.getElementById('val-documento').value || '').trim();
      if (!docRegex.test(documento)){
        return Swal.fire({ icon:'warning', title:'Documento inv√°lido', text:'Ingresa de 6 a 10 d√≠gitos.' });
      }
      try{
        const r = await apiGet('validarUsuario', { documento });
        if (!r || r.existe === false){
          await Swal.fire({ icon:'error', title:'Usuario no Existente', timer:5000, showConfirmButton:false });
          return;
        }
        const st = String(r.estado || '').toUpperCase();
        if (st === 'ACTIVO'){
          await Swal.fire({ icon:'success', title:'USUARIO EXISTENTE', text:'estado ACTIVO', timer:5000, showConfirmButton:false });
        }else if (st === 'INACTIVO'){
          await Swal.fire({ icon:'info', title:'USUARIO EXISTENTE', text:'estado INACTIVO', timer:5000, showConfirmButton:false });
        }else{
          await Swal.fire({ icon:'info', title:'USUARIO EXISTENTE', text:'Estado: ' + (st || 'DESCONOCIDO'), timer:5000, showConfirmButton:false });
        }
      }catch(e){
        Swal.fire({ icon:'error', title:'Error', text:e.message });
      }
    });

    /* PWA: instalar + detecci√≥n (similar a la referencia) */
    let deferredPrompt = null;
    const installButtons = Array.from(document.querySelectorAll('#btn-instalar, #btn-instalar-standalone'));

    function isStandalone(){
      const dmStandalone = window.matchMedia('(display-mode: standalone)').matches;
      const iosStandalone = (window.navigator.standalone === true);
      const dmInstalled = window.matchMedia('(display-mode: installed)').matches;
      return dmStandalone || iosStandalone || dmInstalled;
    }
    function isIOS(){ return /(iphone|ipad|ipod)/i.test(navigator.userAgent || ''); }
    function isMarkedInstalled(){ try{ return localStorage.getItem('appInstalled') === '1'; }catch(_){ return false; } }
    function markInstalled(){ try{ localStorage.setItem('appInstalled', '1'); }catch(_){ } }
    function clearInstalledMark(){ try{ localStorage.removeItem('appInstalled'); }catch(_){ } }

    async function detectInstalled(){
      if (isStandalone()) return true;

      if (typeof navigator.getInstalledRelatedApps === 'function'){
        try{
          const apps = await navigator.getInstalledRelatedApps();
          // Si existe alguna relacionada como webapp, lo consideramos instalado (tolerante).
          const found = Array.isArray(apps) && apps.some(a => a && a.platform === 'webapp');
          if (found){ markInstalled(); return true; }
          else{ clearInstalledMark(); }
        }catch(_){}
      }
      return isMarkedInstalled();
    }

    function updateInstallButtonsVisibility(){
      const installedFlag = isMarkedInstalled();
      const shouldShow = !isStandalone() && !installedFlag && (isIOS() || !!deferredPrompt);
      installButtons.forEach(btn => { if (btn) btn.style.display = shouldShow ? '' : 'none'; });
    }

    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault();
      deferredPrompt = e;
      updateInstallButtonsVisibility();
    });

    window.addEventListener('appinstalled', ()=>{
      markInstalled();
      updateInstallButtonsVisibility();
    });

    installButtons.forEach(btn=>{
      if (!btn) return;
      btn.addEventListener('click', async ()=>{
        if (isIOS()){
          return Swal.fire({
            icon:'info',
            title:'Instalar en iPhone/iPad',
            html:'1) Toca Compartir (cuadro con flecha).<br>2) Elige "Agregar a pantalla de inicio".<br>3) Confirma "Agregar".'
          });
        }
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        const choice = await deferredPrompt.userChoice;
        deferredPrompt = null;
        if (choice.outcome === 'accepted'){
          markInstalled();
          Swal.fire({ icon:'success', title:'¬°App instal√°ndose!', timer:2000, showConfirmButton:false });
        }
        updateInstallButtonsVisibility();
      });
    });

    // #instalar: mostrar vista instalaci√≥n primero; si ya est√° instalada, volver a login
    (function(){
      let installRedirectTimer = null;
      async function openOrInstall(){
        if (location.hash !== '#instalar') return;
        try{ overlay.classList.remove('open'); }catch(_){}
        showView('view-instalar');
        const installed = await detectInstalled();

        if (installRedirectTimer){ clearTimeout(installRedirectTimer); installRedirectTimer = null; }

        if (installed){
          installRedirectTimer = setTimeout(()=>{ showView('view-login'); }, 2000);
        } else {
          updateInstallButtonsVisibility();
        }
      }
      window.addEventListener('load', openOrInstall);
      window.addEventListener('hashchange', openOrInstall);
    })();

    // PWA SW
    if ('serviceWorker' in navigator){
      window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js').catch(()=>{}); });
    }

  </script>
</body>
</html>
